package com.sentinel.control.util

import android.content.Context
import android.content.pm.PackageInfo
import android.content.pm.PackageManager
import android.net.Uri
import com.sentinel.control.logging.SentinelLogger

class MalwareScanner(private val context: Context) {

    fun scan(): MalwareReport {
        val pm = context.packageManager
        val allowList = ALLOW_LIST
        val suspicious = mutableListOf<String>()
        val packages = if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.TIRAMISU) {
            pm.getInstalledPackages(PackageManager.PackageInfoFlags.of(PackageManager.GET_SIGNING_CERTIFICATES.toLong()))
        } else {
            @Suppress("DEPRECATION")
            pm.getInstalledPackages(PackageManager.GET_SIGNATURES)
        }
        for (pkg in packages) {
            if (!isPackageAllowed(pkg, allowList)) {
                suspicious += pkg.packageName
            }
        }
        return MalwareReport(suspicious.isEmpty(), suspicious)
    }

    private fun isPackageAllowed(pkg: PackageInfo, allowList: Set<String>): Boolean {
        if (allowList.contains(pkg.packageName)) return true
        val isSystem = pkg.applicationInfo.flags and android.content.pm.ApplicationInfo.FLAG_SYSTEM != 0
        if (isSystem) return true
        val signatures = if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.P) {
            pkg.signingInfo?.apkContentsSigners?.map { it.toCharsString() } ?: emptyList()
        } else {
            @Suppress("DEPRECATION")
            pkg.signatures?.map { it.toCharsString() } ?: emptyList()
        }
        return signatures.any { TRUSTED_SIGNATURES.contains(it) }
    }

    companion object {
        private val TRUSTED_SIGNATURES = setOf<String>()
        private val ALLOW_LIST = setOf(
            "com.android.settings",
            "com.google.android.gms",
            "com.sentinel.control"
        )
    }
}

data class MalwareReport(val clean: Boolean, val flaggedPackages: List<String>)
